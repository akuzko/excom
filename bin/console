#!/usr/bin/env ruby

require "bundler/setup"
require "excom"

Excom::Sentry.deny_with :unauthorized

class Show < Excom::Command
  use :sentry, class: 'MySentry'
  use :caching
  use :dry_types

  attribute :foo, Dry::Types['int']

  def run
    {foo: foo}
  end
end

class MySentry < Excom::Sentry
  def execute?
    foo != 5
  end

  def save?
    sentry(:save).execute?
  end
end

class Save < Excom::Command
  use :sentry, delegate: [:threshold]
  use :assertions

  args :foo
  opts :bar, :baz

  alias_success :ok

  def foo
    super || 6
  end

  def run
    result ok: foo * 2
    assert { foo > bar }
  end

  def threshold
    0
  end

  sentry do
    def execute?
      foo != 6
    end

    deny_with :unprocessable_entity do
      def execute?
        foo > 0
      end

      def bar?
        bar && bar > threshold
      end
    end
  end
end

require "pry"
Pry.start
